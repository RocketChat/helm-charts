# namespace through cli
---
apiVersion: v1
kind: Secret
metadata:
  name:  mongodb-admin-password
  namespace: "${DETIK_CLIENT_NAMESPACE}"
type: Opaque
stringData:
  password: admin-password
---
apiVersion: v1
kind: Secret
metadata:
  name: mongodb-rocketchat-password
  namespace: "${DETIK_CLIENT_NAMESPACE}"
type:  Opaque
stringData:
  password: rocketchat-password

---
apiVersion: v1
kind: Secret
metadata:
  name: metrics-endpoint-password
  namespace: "${DETIK_CLIENT_NAMESPACE}"
type:  Opaque
stringData:
  password: metrics-password
---
apiVersion: v1
kind: Secret
metadata:
  name: admin-scram-credentials
  namespace: "${DETIK_CLIENT_NAMESPACE}"
type:  Opaque
stringData: 
  username: admin
  password:  admin-scram-password

---
apiVersion: v1
kind: Secret
metadata:
  name: rocketchat-scram-credentials
  namespace: "${DETIK_CLIENT_NAMESPACE}"
type: Opaque
stringData:
  username: rocketchat
  password: rocketchat-scram-password
---
apiVersion: mongodbcommunity.mongodb.com/v1
kind: MongoDBCommunity
metadata: 
  name: ${DEPLOYMENT_NAME}-mongodb
  namespace: "${DETIK_CLIENT_NAMESPACE}"
spec:
  members: 1
  type: ReplicaSet
  version: "8.2.3"
  security:
    authentication: 
      modes:  ["SCRAM"]
    tls:
      enabled: false
  users:
  - name:  admin
    db:  admin
    passwordSecretRef: 
      name: mongodb-admin-password
    scramCredentialsSecretName: admin-scram-credentials
    roles:
    - name: root
      db: admin
  - name: rocketchat
    db: rocketchat
    passwordSecretRef:
      name:  mongodb-rocketchat-password
    scramCredentialsSecretName: rocketchat-scram-credentials
    roles:
    - name: readWrite
      db: rocketchat
  prometheus:
    username:  prometheus-username
    passwordSecretRef:
      name: metrics-endpoint-password
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: "mongodb-kubernetes-appdb"
  namespace: "${DETIK_CLIENT_NAMESPACE}"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: "${DEPLOYMENT_NAME}-${DETIK_CLIENT_NAMESPACE}-mongodb"
rules:
- apiGroups:
  - ""
  resources:
  - services
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - delete
- apiGroups:
  - ""
  resources:
  - secrets
  - configmaps
  verbs:
  - get
  - list
  - create
  - update
  - delete
  - watch
- apiGroups:
  - apps
  resources:
  - statefulsets
  verbs:
  - create
  - get
  - list
  - watch
  - delete
  - update
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - list
  - watch
  - delete
  - update
  - patch
  - deletecollection
- apiGroups:
  - mongodbcommunity.mongodb.com
  resources:
  - mongodbcommunity
  - mongodbcommunity/status
  - mongodbcommunity/spec
  - mongodbcommunity/finalizers
  verbs:
  - '*'
- apiGroups:
  - mongodb.com
  resources:
  - mongodb
  - mongodb/finalizers
  - mongodbusers
  - mongodbusers/finalizers
  - opsmanagers
  - opsmanagers/finalizers
  - mongodbmulticluster
  - mongodbmulticluster/finalizers
  - mongodbsearch
  - mongodbsearch/finalizers
  - mongodb/status
  - mongodbusers/status
  - opsmanagers/status
  - mongodbmulticluster/status
  - mongodbsearch/status
  verbs:
  - '*'
- apiGroups:
  - ""
  resources:
  - namespaces
  verbs:
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: "${DEPLOYMENT_NAME}-${DETIK_CLIENT_NAMESPACE}-mongodb"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: "${DEPLOYMENT_NAME}-${DETIK_CLIENT_NAMESPACE}-mongodb"
subjects:
- kind: ServiceAccount
  name: "mongodb-kubernetes-appdb"
  namespace: "${DETIK_CLIENT_NAMESPACE}"