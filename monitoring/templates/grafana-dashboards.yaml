{{- $folders := concat
  $.Values.grafana.folders.rocketchat
  $.Values.grafana.folders.extra
-}}
{{ range $folder := $folders }}
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaFolder
metadata:
  name: {{ $.Release.Name }}-{{ $folder.name }}
  labels:
    dashboards: "grafana"
spec:
  title: "{{ $folder.name }}"
  {{- if $folder.id }}
  uid: "{{ $folder.id }}"
  {{- end }}
  instanceSelector:
    matchLabels:
      grafana: dashboards
---
{{ end }}

{{- $dashboards := concat
  $.Values.grafana.dashboards.community
  $.Values.grafana.dashboards.rocketchat
  $.Values.grafana.dashboards.extra
-}}

{{ range $dashboard := $dashboards }}
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: {{ $.Release.Name }}-{{ $dashboard.name }}
  labels:
    dashboards: "grafana"
spec:
  allowCrossNamespaceImport: true
  {{- if $dashboard.folder }}
  folderRef: {{ $.Release.Name }}-{{ $dashboard.folder }}
  {{- else }}
  folder: General
  {{- end }}
  instanceSelector:
    matchLabels:
      grafana: dashboards
  datasources:
    - inputName: "DS_PROMETHEUS"
      datasourceName: "prometheus" # this is the one generated by the prometheus-operator
  url: "https://grafana.com/api/dashboards/{{ $dashboard.id }}/revisions/{{ $dashboard.revision }}/download"
  contentCacheDuration: 48h
---
{{ end }}