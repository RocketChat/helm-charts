{{- if and .Values.grafana.enabled .Values.grafana.deploy.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: "{{ .Release.Name }}-grafana-admin-credentials"
  namespace: "{{ .Release.Namespace }}"
type: Opaque
stringData:
  GF_SECURITY_ADMIN_USER: admin
  GF_SECURITY_ADMIN_PASSWORD: admin
---
{{- if and (.Values.operator.prometheus.enabled) (.Values.operator.enabled) }}

apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDatasource
metadata:
  name: "{{ .Release.Name }}-prometheus-datasource"
  namespace: "{{ .Release.Namespace }}"
spec:
  allowCrossNamespaceImport: true
  instanceSelector:
    matchLabels:
      grafana: dashboards
  datasource:
    name: prometheus
    type: prometheus
    access: proxy
    url: http://prometheus-operated.{{.Release.Namespace}}.svc.cluster.local:9090
    isDefault: true
    editable: false
    jsonData:
      "tlsSkipVerify": true
      "timeInterval": {{ $timeInterval := .Values.operator.prometheus.scrapeInterval | default "30s" }}{{ $timeInterval }}
---
{{- end }}

{{- if and .Values.loki.enabled -}}
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDatasource
metadata:
  name: "{{ .Release.Name }}-loki-datasource"
  namespace: "{{ .Release.Namespace }}"
spec:
  allowCrossNamespaceImport: true
  instanceSelector:
    matchLabels:
      grafana: dashboards
  datasource:
    name: loki
    type: loki
    access: proxy
    url: http://{{ .Release.Name }}-loki-gateway.{{ .Release.Namespace }}.svc.cluster.local/
    isDefault: true
    editable: false
    jsonData:
      "tlsSkipVerify": true
      "timeInterval": {{ $timeInterval := .Values.operator.prometheus.scrapeInterval | default "30s" }}{{ $timeInterval }}
---
{{- end -}}

apiVersion: grafana.integreatly.org/v1beta1
kind: Grafana
metadata:
  name: "{{ .Release.Name }}-grafana"
  namespace: "{{ .Release.Namespace }}"
  labels:
    grafana: dashboards  # THIS LABELS is very important
spec:
  config:
    log:
      mode: console
    auth:
      disable_login_form: "false"
  deployment:
    metadata:
      labels:
        grafana: dashboards  # THIS LABELS is very important
    spec:
      strategy:
        type: Recreate
      template:
        metadata:
          labels:
            grafana: dashboards  # THIS LABELS is very important
        spec:
          securityContext:
            fsGroup: 10001
          containers:
            - name: grafana
              resources: {}
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop: ["ALL"]
              env:
                - name: GF_SECURITY_ADMIN_USER
                  valueFrom:
                    secretKeyRef:
                      key: GF_SECURITY_ADMIN_USER
                      name: {{ .Release.Name }}-grafana-admin-credentials
                - name: GF_SECURITY_ADMIN_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: GF_SECURITY_ADMIN_PASSWORD
                      name: {{ .Release.Name }}-grafana-admin-credentials
                - name: GF_SERVER_SERVE_FROM_SUB_PATH
                  value: "{{ eq .Values.ingress.grafana.path "/" | ternary "false" "true" }}"
                - name: GF_SERVER_ROOT_URL
                  {{/* This is hacky, but Grafana requires a trailing slash, but adding two breaks things */}}
                  {{- if hasSuffix "/" .Values.ingress.grafana.path }}
                  value: "{{ .Values.ingress.tls | ternary "https" "http" }}://{{ .Values.ingress.grafana.host }}{{ .Values.ingress.grafana.path | default "" }}"
                  {{- else }}
                  value: "{{ .Values.ingress.tls | ternary "https" "http" }}://{{ .Values.ingress.grafana.host }}{{ .Values.ingress.grafana.path | default "" }}/"
                  {{- end }}
          securityContext:
            fsGroup: 1001
            runAsGroup: 1001
            runAsNonRoot: true
            runAsUser: 1001
          volumes:
            - name: grafana-data
              persistentVolumeClaim:
                claimName: {{ .Release.Name }}-grafana-pvc
  persistentVolumeClaim:
    spec:
      accessModes:
      - ReadWriteOnce
      {{- if .Values.grafana.deploy.storageClassName }}
      storageClassName: "{{ .Values.grafana.deploy.storageClassName | default "" }}"
      {{- end}}
      resources:
        requests:
          storage: 5Gi
---
{{- if .Values.grafana.deploy.nodePort }}
apiVersion: v1
kind: Service
metadata:
  name: "{{ .Release.Name }}-grafana-nodeport"
  namespace: "{{ .Release.Namespace }}"
spec:
  selector:
    grafana: dashboards  # THIS LABELS is very important
  ports:
    - name: grafana
      nodePort: {{ .Values.grafana.deploy.nodePort }}
      port: 3000
      targetPort: 3000
  type: NodePort
{{- end }} # if .Values.grafana.deploy.nodePort
{{- end }} # if .Values.grafana.enabled
